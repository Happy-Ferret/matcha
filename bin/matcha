#!/usr/bin/env node

var argv = require('optimist').argv
  , path = require('path')
  , fs = require('fs')
  , matcha = require('..')
  , cwd = process.cwd();

var ui = require('../lib/interface');

var files = argv._
  , re = /\.js$/;

if (!files.length) {
  files = fs.readdirSync('benchmarks').filter(function(path){
    return path.match(re);
  }).map(function(_p){
    return path.join('benchmarks', _p);
  });
}

files = files.map(function(_p){
  _p = require.resolve(path.join(cwd, _p));
  return _p;
});

var suite = new matcha.Suite();

load(files, function () {
  run(suite, function () {
    console.log('finished')
  });
});

function load (files, cb) {
  var after = files.length;
  ui(suite);
  files.forEach(function (file) {
    delete require.cache[file];
    suite.emit('pre-require', global);
    suite.emit('require', require(file));
    --after || cb();
  });
}

function run (suite, cb) {
  var runner = new matcha.Runner(suite);
  var reporter = new matcha.Reporter(runner);
  runner.run(cb);
}

