#!/usr/bin/env node

var program = require('commander')
  , path = require('path')
  , fs = require('fs')
  , matcha = require('../')
  , cwd = process.cwd();

var ui = require('../lib/interface');

var files = [];

program
  .version(matcha.version)
  .usage('[files]');


program.parse(process.argv);

var files = program.args
  , re = /\.js$/;

if (!files.length) {
  files = fs.readdirSync('benchmarks').filter(function(path){
    return path.match(re);
  }).map(function(_p){
    return path.join('benchmarks', _p);
  });
}

files = files.map(function(_p){
  _p = require.resolve(path.join(cwd, _p));
  return _p;
});

var suite = new matcha.Suite({
  iterations: 500000,
  type: 'static'
});

load(files, function () {
  run(suite, process.exit);
});

function load (files, cb) {
  var after = files.length;
  ui(suite);
  files.forEach(function (file) {
    delete require.cache[file];
    suite.emit('pre-require', global);
    suite.emit('require', require(file));
    --after || cb();
  });
}

function run () {
  suite.run();
}

